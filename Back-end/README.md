# OnAux Back-end

App to create sessions for playing music and requesting songs.

1. [Setup](#setup)
2. [API Documentation](#documentation)
3. [API Unit Testing](#testing)

# Setup

1. [.env Setup](#env-setup)
2. [Local Environment Setup](#local-environment-setup)
3. [Postman Setup](#postman-setup)

---

## Local Environment Setup

1. Install nodeJS by following installation guides from https://nodejs.org/en/download/
2. Clone the repository to your local environment using `git clone https://github.com/alimz758/UCLA-CS-130---SWE---OnAux.git`
3. Navigate to `Back-end` directory
4. Install all used packages and dependencies using:
   > npm install

5. Install mongoDB by following installation guides from:
   Mac: https://treehouse.github.io/installation-guides/mac/mongo-mac.html
   Windows: https://docs.mongodb.com/manual/tutorial/install-mongodb-on-windows/

   This is different from the npm package listed in package.json: which is the driver that connects the DB to the nodeJS app.
   For choosing the inital db location, just use the default --dbpath=/data/db to prevent future confusion

6. Follow the steps below to connect MongoDB to Robo 3T GUI
   https://dzone.com/articles/how-to-connect-your-mongodb-deployments-to-robo-3t



---
## .env Setup

In `Back-end` directory run `npm run-script build`. This command generate the `.env` file and copies(overwrites) the desired environment variables from

`env_variable` to `.env`.

Note: If you created new envirnoment varibles, don't forget to add it to `env_variable` so your teamates can use them as well.


---

## Local Development Setup

1. Open a terminal in `Back-end`, and run the command `mongod` to start the mongodb daemon - may have to run `sudo mongod` for permission purposes
2. Open another terminal and run `npm run dev` in the home directory
3. The local backend development port is set to 8000. You can use Postman for testing APIs

---

## Postman Setup

**Setting Up the Environment**

Follow the steps bellow to set up an environment for Postman to call the APIs

1. Create a new Collection, name it as you desire
2. Click on `More options` for the newly creted collection. Then click `Edit`
3. Then go to `Authorization` tab. From the `Type` drop down menu, choose `Bearer Token` and then in `Token` field write `{{token}}`. Press `Update` afterwards.
4. Now set up the environment.
5. On the top right corner of the screen, click on the setting icon and a `Manage Environments` Tab will open. Click on `Add`
6. Name the enironment as you wish. Then add two variables as follows:
   a. Define a variable `url` and set its Initial Value to `localhost:8000`
   b. Define a variable `token` and leave its Initial Value empty for now as when we call the Sign-up API the token will be set automatically

**Creating a Postman Request**

We first create the Sign-up API request. Follow the steps below:

1. Create a new API request, name it as you wish, under the newly created collection and set it as `Post` request, and type `{{url}}/user/signup` for the request field
2. Under `Body` copy something like the below format as `raw`, `JSON`. change their values as you wish

```
{
    "username" : "newuser1234",
    "email": "newuser@g.ucla.edu",
    "password" : "mypassword"
}
```

3. Under `Tests`, copy the below code to set up the token after sending the request

```
if (pm.response.code === 201) {
   console.log(pm.response.json())
   pm.environment.set('token',pm.response.json().token)
}
```

4. For all other requests that you wish to make, make sure under `Authorization` tab to set `Type` as `inherit auth from parent`

---
## Documentation

## Models & API Endpoints Documentation

Models:

1. [User](#user)
2. [Session](#session)

---

### User

### Schema

| Field          | Type    | Required | Details                                                      |
| -------------- | ------- | -------- | ------------------------------------------------------------ |
| firstName         | String     | Yes      |                  |   
| lastName         | String     | Yes      |                  |   
| userID         | _id     | Yes      | Generated by Mongo, no client code is needed                 |   
| username       | String  | Yes      | unique                                                       |
| email          | String  | Yes      | unique                                                       |
| password       | String  | Yes      |                                                              |
| profilePic     | Buffer  |          |                                                              |
| createdAt      | Date    |          |                                                              |
| tokens         | Array   |          |                                                              |
| djSessionID    | _id     |          |  `sessionID`                                                 |
| likedSongs    | Array     |          |                                                   |

### API Endpoints

| API end-point               | HTTP Method | Required Fields                                                    |  Description                         |
| --------------------------- | ----------- | ------------------------------------------------------------------ | ------------------------------------ |   
| [Login](#login)                | POST        | `username`, `password`                                             |Creates and Returns a JWT Token associated with the user  |
| [Signup](#signup)                | POST        | `username` , `email`, `password`, `firstName`, `lastName` | Registers a user in Database and returns a JWT Token for authentication      |
| [Logout](#logout)              | POST        | None                                                               |         Removes the JWT Token from the user association  | 
| [Get-User](#get-user)     | GET         | Passing `userID` as a parameter                                    | Returns userInfo with given `userID`  | 
| [Upload-Pic](#upload-pic)          | POST        | key: `profile-pic`  , type: `.jpg`, `.png` or `.jpeg`              |          Uploads picture to user profile         |
| [Get-Profile-Pic](#get-profile-pic)        | GET         | None                                                               |   Returns user profile picture          |
| [Delete-Profile-Pic](#delete-profile-pic)           | DELETE      | None                                                       |   Delets user profile picture        |
| [Add-Song](#add-song)              | POST        | `songInfo object` with `songuri`, `songName`, `artist`, `album` in body    | Returns array of songs + information |
| [Get-Likes](#get-likes)                | GET         | None                                             | Returns array of user's liked songs |
| [Remove-Song](#remove-song)          | DELETE      | `songInfo object` with `songuri` in body           | Removes the song with `songuri` from user's likes and returns updated array of liked songs |

---

#### Login

```
Method: POST

End-point : /user/login

Request-Body:
   {
      "username": "newuser",
      "password" : "12d34"
   }

Backend-Response:
   {
      "user": {
         "createdAt": "2020-11-23T04:58:10.240Z",
         "_id": "5fbb41ada4d1c10c041178de",
         "username": "newuser",
         "firstName": "Ali",
         "lastName": "lastName",
         "email": "ali1d@gmail.com",
         "likedSongs": [],
         "__v": 4,
         "djSessionID": "5fbb41b3a4d1c10c041178e0"
      },
      "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJlbWFpbCI6ImFsaTFkQGdtYWlsLmNvbSIsImlhdCI6MTYwNzAzMTA0OCwiZXhwIjoxNjA3MTE3NDQ4fQ.fZ-4lbVrcHKmgXx4hg0YEkDdtMdCXBTaI0xS9VDSRlU"
   }
```

#### Signup

```
Method: POST

End-point : /user/signup

Request-Body:
   {
      "username": "newuser2",
      "firstName" : "Ali",
      "lastName" : "lastName",
      "email": "ali1d3@gmail.com",
      "password" : "12d34"
   }

Backend-Response:
   {
      "user": {
         "createdAt": "2020-12-03T21:30:41.164Z",
         "_id": "5fc959be017ed58034cec08d",
         "username": "newuser3",
         "firstName": "Ali",
         "lastName": "lastName",
         "email": "ali@gmail.com",
         "likedSongs": [],
         "__v": 1
      },
      "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJlbWFpbCI6ImFsaUBnbWFpbC5jb20iLCJpYXQiOjE2MDcwMzEyMzAsImV4cCI6MTYwNzExNzYzMH0.8-5lQ9bCwhCgO131tP6aI5Y9QaIvEC0LMJ8RsVxBo7k"
   }
```


#### Logout

```
Method: POST

End-point : /user/logout

Backend-Response:
   User Logged out!
```

#### Get-User

```
Method: GET

End-point : /user/user-id=:userID

Params:
   1. userID

Backend-Response:
   {
      "userInfo": {
         "createdAt": "2020-12-03T21:30:41.164Z",
         "_id": "5fc959be017ed58034cec08d",
         "username": "newuser3",
         "firstName": "Ali",
         "lastName": "lastName",
         "email": "ali@gmail.com",
         "likedSongs": [],
         "__v": 2
      }
   }
```

#### Upload-Pic

```
Method: POST

End-point : /user/profile-pic

Request-Body:
   key: profile-pic
   value: picture that wnats to be uploaded

```
#### Get-Profile-Pic

```
Method: GET

End-point : /user/profile-pic

```

#### Delete-Profile-Pic

```
Method: DELETE

End-point : /user/profile-pic
```
#### Add-Song

```
Method: POST

End-point : /user/add-song

Request-Body:
   {
      "songInfo": {
         "songuri" : "0176789",
         "songName" : "One of these Nights",
         "artist" : "The Eagles",
         "album" : "Single"
      }
   }

Backend-Response:
   [
      {
         "songuri": "0176789",
         "songName": "One of these Nights",
         "artist": "The Eagles",
         "album": "Single"
      }
   ]
```

#### Get-Likes

```
Method: GET

End-point : /user/likes


Backend-Response:
   [
      {
         "songuri": "0176789",
         "songName": "One of these Nights",
         "artist": "The Eagles",
         "album": "Single"
      },
      {
         "songuri": "0176783",
         "songName": "Heartless",
         "artist": "The Weeknd",
         "album": "After Hours"
      }
   ]
```
#### Remove-Song

```
Method: DELETE

End-point : /user/likes

Request-Body:
   {
      "songInfo": {
         "songuri" : "0176789"
      }
   }

Backend-Response:
   [
      {
         "songuri": "0176783",
         "songName": "Heartless",
         "artist": "The Weeknd",
         "album": "After Hours"
      }
   ]
```

### Session

### Schema

| Field          | Type    | Required | Details                                                      |
| -------------- | ------- | -------- | ------------------------------------------------------------ |
| sessionID      | _id     | Yes      | Generated by Mongo, no client code is needed                |
| sessionName    | String  | Yes      |                                                              |
| owner          | _id     |          |  `userID`                                                    |
| currentSongInfo    | Object  |          |                                                              |
| nextSong       | String  |          |                                                              |
| createdAt      | Date    |          |                                                              |
| histroy        | Array   |          |                                                              |
| requestedSongsMap  | HashMap   |          |                                                              |
| requestedSongObj      | Array     | Yes      | Song Object with their votes              |


### API Endpoints

| API end-point                     | HTTP Method | Required Fields                      | Description                                                                                              |
| ---------------------------       | ----------- | ------------------------------------ | -------------------------------------------------------------------------------------------------------- |
| [Create-Session](#create-session)                  | POST        | `sessionName`                        | Create a new session to become a DJ, Returns userInfo with sessionID + newly created Session information |
| [Get-Session](#get-session)   | GET         | passing `sessionID` as a parameter   | Get all information about a session, has to pass the sessionID as a parameter                            |
| [Get-All-Session](#get-all-sessions)                     | GET         | None                                 | Returning all available/active sessions with their `sessionName`s and `sessionID`s                        |
| [Request-Song](#request-song)                  | POST         | `sessionID` as a  param, `songInfo` and `vote`(+1/-1) in body                                | returning the updated session in JSON                         |
| [Set-Current-Song](#set-current-song)                   | POST        | `sessionID`, `songInfo` as a body                           | Set the current soong being played                         |
| [Add-Song-History](#add-song-history)                  | POST        | Song object in the body                    | Adding a song to the session history |
| [Get-Session-History](#get-session-history)                  | GET        | Song object  in the body                       | Get the session hostory|


---


#### Create-Session

```
Method: POST

End-point : /session/create

Request-Body:
   {
      "sessionName" : "Adam's session"
   }

Backend-Response:
   {
      "userAsDJWithSessionID": {
         "createdAt": "2020-12-03T21:30:41.164Z",
         "_id": "5fc95d8b017ed58034cec091",
         "username": "newuser3e",
         "firstName": "Ali",
         "lastName": "lastName",
         "email": "alie@gmail.com",
         "likedSongs": [
               {
                  "_id": "5fc96278017ed58034cec095"
               }
         ],
         "__v": 4,
         "djSessionID": "5fc964b9017ed58034cec097"
      },
      "newSessionInfo": {
         "createdAt": "2020-12-03T21:30:41.139Z",
         "_id": "5fc964b9017ed58034cec097",
         "sessionName": "Adam's session",
         "owner": "5fc95d8b017ed58034cec091",
         "history": [],
         "requestedSongObj": [],
         "__v": 0
      }
   }
```

#### Get-Session

```
Method: GET

End-point : /session/session-id=:sessionID

Params:
   1. sessionID

Backend-Response:
   {
      "createdAt": "2020-12-02T05:46:23.292Z",
      "_id": "5fc72a43710d3803f4fff129",
      "sessionName": "Adam's session",
      "owner": "5fc713a0b6dea9fb5c0136f9",
      "history": [],
      "requestedSongObj": [
         {
               "_id": "5fc72a58710d3803f4fff12b",
               "songuri": "8498462",
               "songName": "Sad Sad City",
               "artist": "Ghostland Observatory",
               "album": "Single",
               "vote": 2
         },
         {
               "_id": "5fc72ae09c27cb0470b771ef",
               "songuri": "8498463",
               "songName": "Bad & Boujee",
               "artist": "Migos",
               "album": "Single",
               "vote": -2
         },
         {
               "_id": "5fc72afb9c27cb0470b771f0",
               "songuri": "84938463",
               "songName": "Bad & Boujee",
               "artist": "Migos",
               "album": "Single",
               "vote": 1
         }
      ],
      "__v": 4
   }
```

#### Get-All-Sessions

```
Method: GET

End-point : /session/all

Backend-Response:
[
    {
        "_id": "5fadd2868ee28252e1416d80",
        "sessionName": "Adam's session"
    },
    {
        "_id": "5fbb41b3a4d1c10c041178e0",
        "sessionName": "Ali's session"
    },
    {
        "_id": "5fbefa66cdee235c6bced5cc",
        "sessionName": "Nick's session"
    },
    {
        "_id": "5fc713a4b6dea9fb5c0136fb",
        "sessionName": "Emily's session"
    },
    {
        "_id": "5fc72a43710d3803f4fff129",
        "sessionName": "Hannah's session"
    }
]
```

#### Request-Song

```
Method: POST

End-point : /session/session-id=:sessionID/request-song

Request-Body:
   {
      "songInfo": {
         "songuri" : "84938463",
         "songName" : "Bad & Boujee",
         "artist" : "Migos",
         "album" : "Single"
      },
      "vote" : "1"
   }

Backend-Response:
   {
      "createdAt": "2020-12-02T05:46:23.292Z",
      "_id": "5fc72a43710d3803f4fff129",
      "sessionName": "Adam's session",
      "owner": "5fc713a0b6dea9fb5c0136f9",
      "history": [],
      "requestedSongObj": [
         {
               "_id": "5fc72a58710d3803f4fff12b",
               "songuri": "8498462",
               "songName": "Sad Sad City",
               "artist": "Ghostland Observatory",
               "album": "Single",
               "vote": 2
         },
         {
               "_id": "5fc72ae09c27cb0470b771ef",
               "songuri": "8498463",
               "songName": "Bad & Boujee",
               "artist": "Migos",
               "album": "Single",
               "vote": -2
         },
         {
               "_id": "5fc96651017ed58034cec099",
               "songuri": "84938463",
               "songName": "Bad & Boujee",
               "artist": "Migos",
               "album": "Single",
               "vote": 3
         }
      ],
      "__v": 6
   }
```

#### Set-Current-song

```
Method: POST

End-point : /session/session-id=:sessionID/set-current-song

Request-Body:
   {
      "songInfo": {
         "songuri" : "849846161",
         "songName" : "Sad Sad City",
         "artist" : "Ghostland Observatory",
         "album" : "Single"
      }
   }

Backend-Response:
{
    "currentSongInfo": {
        "songuri": "849846161",
        "songName": "Sad Sad City",
        "artist": "Ghostland Observatory",
        "album": "Single"
    },
    "createdAt": "2020-11-23T04:58:10.223Z",
    "_id": "5fbb41b3a4d1c10c041178e0",
    "sessionName": "Adam's session",
    "owner": "5fbb41ada4d1c10c041178de",
    "history": [],
    "__v": 1,
    "requestedSongObj": []
}
```

#### Add-Song-History

```
Method: POST

End-point : /session/session-id=:sessionID/history/add-song

Request-Body:
   {
      "songInfo": {
         "songuri" : "849846161",
         "songName" : "Sad Sad City",
         "artist" : "Ghostland Observatory",
         "album" : "Single"
      }
   }

Backend-Response:
[
    {
        "songuri": "849846161",
        "songName": "Sad Sad City",
        "artist": "Ghostland Observatory",
        "album": "Single"
    },
    {
        "songuri": "849846121",
        "songName": "Bad & Boujee",
        "artist": "Migos",
        "album": "Single"
    }
]
```

#### Get-Session-History

```
Method: GET

End-point : /session/session-id=:sessionID/history/

Backend-Response:
   [
      {
         "songuri": "849846161",
         "songName": "Sad Sad City",
         "artist": "Ghostland Observatory",
         "album": "Single"
      },
      {
         "songuri": "849846121",
         "songName": "Bad & Boujee",
         "artist": "Migos",
         "album": "Single"
      }
   ]
```
---
## API Unit Testing
---

**Prerequisites for API Testing**
1. Open a teminal session to UCLA-CS-130---SWE---OnAux/ root and run `mongod`
2. Open another teminal session to UCLA-CS-130---SWE---OnAux/Back-end/ directory and run `npm run dev`
3. Open Postman app

**Running APIs in postman**
1. Preceede all API endpoints with `localhost:8000`
2. Add an environment variable in the top right called `token`.  You will update this token in API testing, and it is how our backend authenticates API requests.
3. Click `New Request` in the upper left hand corner.
4. Fill in the API request url, specify the type of API request, and the required API body or params.

**API Unit Testing Order**

